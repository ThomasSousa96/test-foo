name: Cache cleanup

on:
  workflow_dispatch:

jobs:
  gh-cache-cleanup:
    name: Github cache cleanup
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Github cache list
        run: |
          gh cache list --json id --json key --json ref --json sizeInBytes --json version --json lastAccessedAt --json createdAt
      - name: Github Actions cache cleanup
        run: |
          echo "Fetching list of cache key"
          cacheKeysForPR=$(gh actions-cache list -R ${{ github.repository }} -B $BRANCH -L 100 | cut -f 1 )
          
          set +e
          echo "Deleting caches..."
          for cacheKey in $cacheKeysForPR
          do
              echo "Delete $cacheKey"
              # gh actions-cache delete $cacheKey -R ${{ github.repository }} -B $BRANCH --confirm
          done
          echo "Done"
